name: Download-Clang-21

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:

jobs:
  build-kernel-sukisu-susfs:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: "8G"
      KBUILD_BUILD_USER: "DawnFz"
      KBUILD_BUILD_HOST: "Github"
      CONFIG: "android14-6.1-LTS"
      GOOGLE_SOURCE_URL: "https://android.googlesource.com"

    steps:
      - name: 初始化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: 配置环境变量
        run: |
          CHASH=$(date +%s%N | sha1sum | cut -c1-12)
          echo "本次构建哈希:$CHASH"
          echo "CCACHE_DIR=$HOME/.ccache_6.1.lts" >> $GITHUB_ENV
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "BOOTHASH=$CHASH" >> $GITHUB_ENV
          TIMESTAMP=$(date -u '+%a %b %e %T %Z %Y')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: 拉取内核源码
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          $GITHUB_WORKSPACE/./git-repo/repo init --depth=1 -u https://${{ secrets.PATCH_ACCESS_TOKEN }}@github.com/OgayCn/Kernel-Patch.git -b refs/heads/main -m SM8650_Custom.xml
          $GITHUB_WORKSPACE/./git-repo/repo --trace sync -c -j$(nproc --all) --no-tags --fail-fast